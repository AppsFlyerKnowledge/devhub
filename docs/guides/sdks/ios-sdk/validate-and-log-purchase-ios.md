---
title: "Validate and log purchase"
slug: "validate-and-log-purchase-ios"
category: 5f9705393c689a065c409b23
parentDoc: 5fa043dd3b65b20045e35597
excerpt: "Learn how to validate and log purchases."
hidden: false
createdAt: "2024-04-21T19:00:15.000Z"
updatedAt: "2024-04-21T19:00:15.000Z"
order: 13
---

ImplementingÂ `validateAndLogInAppPurchase`Â enables your app to send in-app purchase events generated by the App Store. 

> ðŸ“˜Note
> 
> 
> The functionÂ [`validateAndLogInAppPurchase`](https://dev.appsflyer.com/hc/docs/android-sdk-reference-appsflyerlib#validateandloginapppurchase)Â can be replaced by the fully automatic purchase SDK connector (a premium service). To learn how to integrate the connector, see in GithubÂ [Android purchase SDK connector](https://github.com/AppsFlyerSDK/appsflyer-android-purchase-connector)

## [New] validateAndLogInAppPurchase

TheÂ method validates a purchase event with the store and if the validation is successful, the SDK sends anÂ [`af_purchase`](https://dev.appsflyer.com/hc/docs/in-app-events-ios#af_purchase)Â event to AppsFlyer.  

**Method signature**

```objectivec
typedef void (^AFSDKValidateAndLogCompletion)(AFSDKValidateAndLogResult * _Nullable result);
- (void)validateAndLogInAppPurchase:(AFSDKPurchaseDetails *)details
                   extraEventValues:(NSDictionary * _Nullable)extraEventValues
                  completionHandler:(AFSDKValidateAndLogCompletion)completionHandler NS_AVAILABLE(10_7, 7_0);
```

**Input parameters**

| Name | Type | Description |
| --- | --- | --- |
| `details`* | ['AFSDKPurchaseDetails'](#afsdkpurchasedetails)* | An object that encapsulates all data related to the purchase provided to the validateAndLogInAppPurchase method. |
| `extraEventValues` | NSDictionary * _Nullable | An optional dictionary containing additional parameters to log with the purchase event. |
| `completionHandler`* | `AFSDKValidateAndLogCompletion` | A completion handler block that is called with the result of the purchase validation and logging.  |

**Note**

> ðŸ“˜Note
> 
> 
> The `validateAndLogInAppPurchase` method triggers an `af_purchase` in-app event upon successful validation. Manually sending this event may result in duplicate event reporting.
> 

### AFSDKPurchaseDetails

An object that encapsulates all data related to the purchase provided to the `validateAndLogInAppPurchase` method.

```objectivec
@interface AFSDKPurchaseDetails : NSObject

- (nonnull instancetype)init NS_UNAVAILABLE;
+ (nonnull instancetype)new NS_UNAVAILABLE;

@property (strong, nullable, nonatomic) NSString *productId;
@property (strong, nullable, nonatomic) NSString *price;
@property (strong, nullable, nonatomic) NSString *currency;
@property (strong, nullable, nonatomic) NSString *transactionId;

- (instancetype _Nonnull )initWithProductId:(NSString *_Nullable)productId
                                      price:(NSString *_Nullable)price
                                   currency:(NSString *_Nullable)currency
                              transactionId:(NSString *_Nullable)transactionId;

```

**AFSDKPurchaseDetails Parameters**

| Name | Type | Description |
| --- | --- | --- |
| `productId` | String | The product identifier for the purchase.  |
| `price` | String | The price of the product.  |
| `currency` | String | The currency used for the billing operation. |
| `transactionId` | String | A specific identifier for the transaction.  |

### Testing purchase validation in Sandbox mode

To test purchase validation using a sandboxed environment, add the following code:

`[AppsFlyerLib shared].useReceiptValidationSandbox = YES;`

> ðŸ“˜Note
> 
> 
> This code must be removed from your production builds.

## [Legacy] validateAndLogInAppPurchase

### Purchase validation using validateAndLogInAppPurchase

`validateAndLoginInAppPurchase` takes these arguments:

```objectivec
- (void) validateAndLogInAppPurchase:(NSString *) productIdentifier,
                  price:(NSString *) price
                  currency:(NSString *) currency
                  transactionId:(NSString *) tranactionId
                  additionalParameters:(NSDictionary *) params
                  success:(void (^)(NSDictionary *response)) successBlock
                  failure:(void (^)(NSError *error, id reponse)) failedBlock;
```
```swift
validateAndLog(inAppPurchase: String?,
               price: String?,
               currency: String?,
               transactionId: String?,
               additionalParameters: [AnyHashable : Any]?,
               success: ([AnyHashable : Any]) -> Void)?,
               failure: ((Error?, Any?) -> Void)?)
```

Upon successful validation, a `NSDictionary` is returned with the receipt validation data (provided by Apple servers).

> ðŸ“˜ Note
> 
> Calling [`validateAndLogInAppPurchase`](doc:ios-sdk-reference-appsflyerlib#validateandlog) generates an [`af_purchase`](https://dev.appsflyer.com/hc/docs/in-app-events-ios#af_purchase) in-app event upon successful validation. Sending this event yourself creates duplicate event reporting.

### Example: Validate in-app purchase

```objectivec
[[AppsFlyerLib shared] validateAndLogInAppPurchase:@"ProductIdentifier" price:@"price"
    currency:@"USD"
    transactionId:@"transactionID"
    additionalParameters:@{@"test": @"val" , @"test1" : @"val 1"}
    success:^(NSDictionary *result){
      NSLog(@"Purchase succeeded And verified! response: %@", result[@"receipt"]);
    } failure:^(NSError *error, id response) {
      NSLog(@"response = %@", response);
      if([response isKindOfClass:[NSDictionary class]]) {
        if([response[@"status"] isEqualToString:@"in_app_arr_empty"]){
          // retry with 'SKReceiptRefreshRequest' because
          // Apple has returned an empty response
          // <YOUR CODE HERE>
        }

      } else {
        //handle other errors
        return;
      }
  }];
```
```swift
AppsFlyerLib.shared().validateAndLogInAppPurchase (
  inAppPurchase: "productIdentifier",
  price: "price",
  currency: "currency",
  transactionId: "transactionId",
  additionalParameters: [:],
  success: {
      guard let dictionary = $0 as? [String:Any] else { return }
      dump(dictionary)
    }, 
  failure: { error, result in
      guard let emptyInApp = result as? [String:Any],
      let status = emptyInApp["status"] as? String,
      status == "in_app_arr_empty" else {
      // Try to handle other errors
      return
    }     
    })
```

#### Testing purchase validation in Sandbox mode

To test purchase validation using a sandboxed environment, add the following code:

```objectivec
[AppsFlyerLib shared].useReceiptValidationSandbox = YES;
```
```swift
AppsFlyerLib.shared().useReceiptValidationSandbox = true
```

> ðŸ“˜ Note
> 
> This code must be removed from your production builds.

Validating an in-app purchase automatically generates and sends an in-app purchase event to AppsFlyer. Its `eventValues` will look something like this:

```json
{
   "some_parameter": "some_value", // from additional_event_values
   "af_currency": "USD", // from currency
   "af_content_id" :"test_id", // from purchase
   "af_revenue": "10", // from revenue
   "af_quantity": "1", // from purchase
   "af_validated": true // flag that AF verified the purchase
}
```
