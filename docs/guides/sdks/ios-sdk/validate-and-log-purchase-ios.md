---
title: "Validate and log purchase"
slug: "validate-and-log-purchase-ios"
category: 5f9705393c689a065c409b23
parentDoc: 694abcd9cfedb7e4931ce19b
excerpt: "Learn how to validate and log purchases."
hidden: false
order: 1
---

The `validateAndLogInAppPurchase` method is part of [the receipt validation flow](https://support.appsflyer.com/hc/en-us/articles/23699097695249--Closed-Beta-Basic-receipt-validation#appsflyer-subscription-revenue-solution-setup), which enables your app to validate in-app purchase events generated by the App Store.

> ðŸ“˜Note
> 
> The function `validateAndLogInAppPurchase` can be replaced by the fully automatic purchase SDK connector (a premium service). To learn how to integrate the connector, see on Github [iOS purchase SDK connector](https://github.com/AppsFlyerSDK/appsflyer-apple-purchase-connector).

The method is currently implemented in two versions.

- [validateAndLogInAppPurchase](#implement-validateandloginapppurchase-beta) supported from SDK v.6.17.8
- [validateAndLogInAppPurchase - Legacy](#validateandloginapppurchase-legacy) 

## Implement validateAndLogInAppPurchase

The [validateAndLogInAppPurchase](https://dev.appsflyer.com/hc/docs/ios-sdk-reference-appsflyerlib#validateandloginapppurchase) method (currently in BETA) sends the purchase details to AppsFlyer for validation. After AppsFlyer validates the purchase with the App Store, the method returns the response to a completion handler block.

**To implement the method, perform the following steps:**

1. Query the App Store for the object of the in-app purchase event. 
2. Initialize an [AFSDKPurchaseDetails](https://dev.appsflyer.com/hc/docs/ios-sdk-reference-appsflyerlib#afsdkpurchasedetails) instance and set it with the purchase type, token, and product ID details retrieved from the Purchase object.
3. If you want to add additional details to the purchase in-app event, populate a dictionary with key-value pairs.
4. Invoke `validateAndLogInAppPurchase` with the following arguments:
   - The `AFSDKPurchaseDetails` object you created in step 2.
   - The dictionary with the additional details you created in step 3.
5. Add your logic for handling the failure, success, or error responses to a completion handler block in the function body.

If the validation is successful, an [`af_purchase`](https://dev.appsflyer.com/hc/docs/in-app-events-ios#af_purchase) event is logged with the values provided to `validateAndLogInAppPurchase`.

> ðŸ“˜Note
> 
> `validateAndLogInAppPurchase` generates an `af_purchase` in-app event upon successful validation. Sending this event yourself will cause duplicate event reporting.

### Code example

```swift
func sampleCodeValidateAndLog(){
    let productId = "my-product-id"
    let transactionId = "12345-transaction-id"
    // Create a new instance of AFSDKPurchaseDetails with the required information
    let purchaseDetails = AFSDKPurchaseDetails(
        productId: productId, 
        transactionId: transactionId, 
       purchaseType: .subscription
    )

    let additionalDetails: [AnyHashable: Any] = [
        "custom_param_1": "value1"
    ]

    AppsFlyerLib.shared().validateAndLog(inAppPurchase: purchaseDetails,
                                     purchaseAdditionalDetails: additionalDetails) { (response, error) in
      // This block is executed when the logging and validation operation is complete.                              
        if let error = error {
                // Process failure error data
                print("Validation failed: \(error.localizedDescription)")
            } else if let response = response {
                // Process successful result data
                print("Validation succeeded: \(response)")
            } else {
                print("No response received.")
        }
    }
}
```

**Subscription purchase that failed validation**

```json
{
  "result": false,
  "status": "failure",
  "product_id": "my-product-id",
  "price": "1.99",
  "currency": "USD",
  "transaction_id": "12345-transaction-id",
  "error": {
    "code": 100,
    "message": "Invalid purchase token or product id."
  },
  "additional_parameters": {
    "firstExtraEventValue": "something",
    "secondExtraEventValue": "nice"
  }
}
```
## Testing purchase validation in Sandbox mode

To test purchase validation using a sandboxed environment, add the following code:

```objectivec
[AppsFlyerLib shared].useReceiptValidationSandbox = YES;
```
```swift
AppsFlyerLib.shared().useReceiptValidationSandbox = true
```

> ðŸ“˜ Note
> 
> This code must be removed from your production builds.

Validating an in-app purchase automatically generates and sends an in-app purchase event to AppsFlyer. Its `eventValues` will look something like this:

```json
{
   "some_parameter": "some_value", // from additional_event_values
   "af_currency": "USD", // from currency
   "af_content_id" :"test_id", // from purchase
   "af_revenue": "10", // from revenue
   "af_quantity": "1", // from purchase
   "af_validated": true // flag that AF verified the purchase
}
```

## validateAndLogInAppPurchase (LEGACY)

### Purchase validation using validateAndLogInAppPurchase

[`validateAndLoginInAppPurchase`](https://dev.appsflyer.com/hc/docs/ios-sdk-reference-appsflyerlib#validateandloginapppurchase-legacy) takes these arguments:

```objectivec
- (void) validateAndLogInAppPurchase:(NSString *) productIdentifier,
                  price:(NSString *) price
                  currency:(NSString *) currency
                  transactionId:(NSString *) tranactionId
                  additionalParameters:(NSDictionary *) params
                  success:(void (^)(NSDictionary *response)) successBlock
                  failure:(void (^)(NSError *error, id reponse)) failedBlock;
```
```swift
validateAndLog(inAppPurchase: String?,
               price: String?,
               currency: String?,
               transactionId: String?,
               additionalParameters: [AnyHashable : Any]?,
               success: ([AnyHashable : Any]) -> Void)?,
               failure: ((Error?, Any?) -> Void)?)
```

Upon successful validation, a `NSDictionary` is returned with the receipt validation data (provided by Apple servers).

> ðŸ“˜ Note
> 
> Calling `validateAndLogInAppPurchase` generates an [`af_purchase`](https://dev.appsflyer.com/hc/docs/in-app-events-ios#af_purchase) in-app event upon successful validation. Sending this event yourself creates duplicate event reporting.

### Example: Validate in-app purchase

```objectivec
[[AppsFlyerLib shared] validateAndLogInAppPurchase:@"ProductIdentifier" price:@"price"
    currency:@"USD"
    transactionId:@"transactionID"
    additionalParameters:@{@"test": @"val" , @"test1" : @"val 1"}
    success:^(NSDictionary *result){
      NSLog(@"Purchase succeeded And verified! response: %@", result[@"receipt"]);
    } failure:^(NSError *error, id response) {
      NSLog(@"response = %@", response);
      if([response isKindOfClass:[NSDictionary class]]) {
        if([response[@"status"] isEqualToString:@"in_app_arr_empty"]){
          // retry with 'SKReceiptRefreshRequest' because
          // Apple has returned an empty response
          // <YOUR CODE HERE>
        }

      } else {
        //handle other errors
        return;
      }
  }];
```
```swift
AppsFlyerLib.shared().validateAndLogInAppPurchase (
  inAppPurchase: "productIdentifier",
  price: "price",
  currency: "currency",
  transactionId: "transactionId",
  additionalParameters: [:],
  success: {
      guard let dictionary = $0 as? [String:Any] else { return }
      dump(dictionary)
    }, 
  failure: { error, result in
      guard let emptyInApp = result as? [String:Any],
      let status = emptyInApp["status"] as? String,
      status == "in_app_arr_empty" else {
      // Try to handle other errors
      return
    }     
    })
```
