---
title: "Validate and log purchase"
slug: "validate-and-log-purchase-android"
category: 5f9705393c689a065c409b23
parentDoc: 5fa0443749be540011850e51
excerpt: "Learn how to validate and log purchases."
hidden: false
createdAt: "2024-04-21T19:00:15.000Z"
updatedAt: "2024-04-21T19:00:15.000Z"
order: 13
---

ImplementingÂ `validateAndLogInAppPurchase`Â enables your app to send in-app purchase events generated by the App Store. 

> ðŸ“˜Note
> 
> 
> The functionÂ [`validateAndLogInAppPurchase`](https://dev.appsflyer.com/hc/docs/android-sdk-reference-appsflyerlib#validateandloginapppurchase)Â can be replaced by the fully automatic purchase SDK connector (a premium service). To learn how to integrate the connector, see in GithubÂ [Android purchase SDK connector](https://github.com/AppsFlyerSDK/appsflyer-android-purchase-connector)

## [New] validateAndLogInAppPurchase

TheÂ method validates a purchase event with the store and if the validation is successful, the SDK sends anÂ [`af_purchase`](https://dev.appsflyer.com/hc/docs/in-app-events-android#af_purchase)Â event to AppsFlyer.  

**Method signature**

```java
public abstract void validateAndLogInAppPurchase(@NonNull AFPurchaseDetails purchaseDetails,
                                                 @Nullable Map<String, String> additionalParameters,
                                                 @Nullable AppsFlyerInAppPurchaseValidationCallback validationCallback);
```

**Input arguments**

| Name | Type | Description |
| --- | --- | --- |
| `purchaseDetails` * |[`AFPurchaseDetails`](#afpurchasedetails) | An object that encapsulates all data related to the purchase provided to the validateAndLogInAppPurchase method. |
| `additionalParameters` | Map<String, String> | Additional parameters to log with the purchase. |
| `validationCallback` * | [`AppsFlyerInAppPurchaseValidationCallback`](#appsflyerinapppurchasevalidationcallback)` | A callback for delivering validation results. |

### AFPurchaseDetails

An object that encapsulates all data related to the purchase provided to the validateAndLogInAppPurchase method.

```kotlin
data class AFPurchaseDetails(
    val purchaseType: AFPurchaseType,
    val purchaseToken: String,
    val productId: String,
    val price: String,
    val currency: String
)
```

**AFPurchaseDetails parameters**

| Name | Type | Description |
| --- | --- | --- |
| `purchaseType` | `AFPurchaseType` | Field to distinguish between one-time purchases and subscriptions. The field can accept either subscription or one-time-purchase. |
| `purchaseToken` | String | Token that uniquely identifies a purchase for a given item and user pair. Part of the Billing Library's [`Purchase class`](https://developer.android.com/reference/com/android/billingclient/api/Purchase). To retrieve the token call the [`getPurchaseToken` API](https://developer.android.com/reference/com/android/billingclient/api/Purchase#getPurchaseToken()) |
| `productId` | String | ID of the product item that has been purchased. Also part of the Billing Library's [`Purchase class`](https://developer.android.com/reference/com/android/billingclient/api/Purchase). |
| `price` | String | The full price of the one-time purchase or the subscription. Also part of the Billing Library's [`Purchase class`](https://developer.android.com/reference/com/android/billingclient/api/Purchase). |
| `currency` | String | Currency used to make the purchase.  |

> ðŸ“˜Note
> 
> 
> The `validateAndLogInAppPurchase` method triggers an [`af_purchase`](https://dev.appsflyer.com/hc/docs/in-app-events-android#af_purchase) in-app event upon successful validation. Manually sending this event may result in duplicate event reporting.
> 

### AppsFlyerInAppPurchaseValidationCallback

A callback interface enabling users to directly receive the results or errors from the Google Play API validation.

**Interface specification**

```kotlin
interface AppsFlyerInAppPurchaseValidationCallback {
    fun onInAppPurchaseValidationFinished(validationResult: Map<String, Any?>)
    fun onInAppPurchaseValidationError(validationError: Map<String, Any?>)
}

```

**Methods**

| Name | Parameters | Description |
| --- | --- | --- |
| `onInAppPurchaseValidationFinished` | validationResult: Map<String, Any?> | Invoked when the in-app purchase validation is completed successfully, providing the validation result (success or failure). |
| `onInAppPurchaseValidationError` | validationError: Map<String, Any?> | Invoked when there is an error during in-app purchase validation, providing the error data. |

**Note**: If users do not require the validation results, passing `null` for the callback is permissible. The SDK will still process the request and follow any necessary retry logic but will not communicate any results back to the user.

## [Legacy] validateAndLogInAppPurchase 

[`validateAndLogInAppPurchase`](doc:android-sdk-reference-appsflyerlib#validateandloginapppurchase) is exposed via [`AppsFlyerLib`](doc:android-sdk-reference-appsflyerlib).

`validateAndLognInAppPurchase` takes these arguments:

```java
validateAndLogInAppPurchase(Context context,
                            java.lang.String publicKey,
                            java.lang.String signature,
                            java.lang.String purchaseData,
                            java.lang.String price, java.lang.String currency,
                            java.util.Map<java.lang.String,java.lang.String> additionalParameters)
```

- `context`: Application / Activity context
- `publicKey`: License Key obtained from the Google Play Console
- `signature`: `data.INAPP_DATA_SIGNATURE` from `onActivityResult`
- `purchaseData`: `data.INAPP_PURCHASE_DATA` from `onActivityResult`
- `price`: Purchase price, should be derived from `skuDetails.getStringArrayList("DETAILS_LIST")`
- `currency`: Purchase currency, should be derived from `skuDetails.getStringArrayList("DETAILS_LIST")`
- `additionalParameters` - Additional event parameters to log

If the validation is successful, an [`af_purchase`](https://dev.appsflyer.com/hc/docs/in-app-events-android#af_purchase) event is logged with the values provided to [`validateAndLogInAppPurchase`](doc:android-sdk-reference-appsflyerlib#validateandloginapppurchase).

> ðŸ“˜ Note
> 
> [`validateAndLogInAppPurchase`](doc:android-sdk-reference-appsflyerlib#validateandloginapppurchase) generates an [`af_purchase`](https://dev.appsflyer.com/hc/docs/in-app-events-android#af_purchase) in-app event upon successful validation. Sending this event yourself will cause duplicate event reporting.

### Example: Validate an in-app purchase

```java
// Purchase object is returned by Google API in onPurchasesUpdated() callback
private void handlePurchase(Purchase purchase) {
    Log.d(LOG_TAG, "Purchase successful!");
    Map<String, String> eventValues = new HashMap<>();
    eventValues.put("some_parameter", "some_value");
    AppsFlyerLib.getInstance().validateAndLogInAppPurchase(getApplicationContext(),
                                                           PUBLIC_KEY,
                                                           purchase.getSignature(),
                                                           purchase.getOriginalJson(),
                                                           "10",
                                                           "USD",
                                                           eventValues);
}
```
```kotlin
// Purchase object is returned by Google API in onPurchasesUpdated() callback
private fun handlePurchase(Purchase purchase) {
   Log.d(LOG_TAG, "Purchase successful!")
   val eventValues = HashMap<String, String>()
   eventValues.put("some_parameter", "some_value")
   AppsFlyerLib.getInstance().validateAndLogInAppPurchase(this,
                                                          PUBLIC_KEY,
                                                          purchase.getSignature(),
                                                          purchase.getOriginalJson(),
                                                          "10",
                                                          "USD",
                                                          eventValues)
}
```

### Handling purchase validation success/failure

Use [`AppsFlyerInAppPurchaseValidatorListener`](doc:android-sdk-reference-appsflyerinapppurchasevalidatorlistener) to subscribe to purchase validation successes/failures and [`registerValidatorListener`](doc:android-sdk-reference-appsflyerlib#registervalidatorlistener) to register it in your Application class.

[`registerValidatorListener`](doc:android-sdk-reference-appsflyerlib#registervalidatorlistener) is exposed via [`AppsFlyerLib`](doc:android-sdk-reference-appsflyerlib). To use [`AppsFlyerInAppPurchaseValidatorListener`](doc:android-sdk-reference-appsflyerinapppurchasevalidatorlistener), import it:

```java Java
import com.appsflyer.AppsFlyerInAppPurchaseValidatorListener;
```
```kotlin Kotlin
import com.appsflyer.AppsFlyerInAppPurchaseValidatorListener
```

[`AppsFlyerInAppPurchaseValidatorListener`](doc:android-sdk-reference-appsflyerinapppurchasevalidatorlistener) has two callbacks:

- [`onValidateInApp`](doc:android-sdk-reference-appsflyerinapppurchasevalidatorlistener#onvalidateinapp): Triggered upon successful purchase validation
- [`onValidateInAppFailure`](doc:android-sdk-reference-appsflyerinapppurchasevalidatorlistener#onvalidateinappfailure): Triggered upon failed purchase validations

[`registerValidatorListener`](doc:android-sdk-reference-appsflyerlib#registervalidatorlistener) takes 2 arguments:

- `context`: The Application Context
- `validationListener`: The `AppsFlyerInAppPurchaseValidatorListener` object you wish to register

```java
AppsFlyerLib.getInstance().registerValidatorListener(this,new
   AppsFlyerInAppPurchaseValidatorListener() {
     public void onValidateInApp() {
       Log.d(TAG, "Purchase validated successfully");
     }
     public void onValidateInAppFailure(String error) {
       Log.d(TAG, "onValidateInAppFailure called: " + error);
     }
});
```
```kotlin
AppsFlyerLib.getInstance().registerValidatorListener(this, object : AppsFlyerInAppPurchaseValidatorListener {
    override fun onValidateInApp() {
       	Log.d(LOG_TAG, "Purchase validated successfully")
    }

    override fun onValidateInAppFailure(error: String) {
        Log.d(LOG_TAG, "onValidateInAppFailure called: $error")
   }
})
```

Validating an in-app purchase automatically sends an in-app purchase event to AppsFlyer. See the following sample data that is passed in the event_value parameter:

```json JSON
{
   "some_parameter": "some_value", // from additional_event_values
   "af_currency": "USD", // from currency
   "af_content_id" :"test_id", // from purchase
   "af_revenue": "10", // from revenue
   "af_quantity": "1", // from purchase
   "af_validated": true // flag that AF verified the purchase
}
```

